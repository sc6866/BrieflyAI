# 🔧 故障排查：Gemini API 速率限制

## 问题症状

同步时出现错误："同步过程发生异常，请检查网络或配置。"

## 可能的原因

### 1. API 速率限制（Rate Limit）

Gemini API 有速率限制，常见情况：
- **免费版**：每分钟 15 次请求（RPM）
- **付费版**：根据套餐不同，限制更高

如果短时间内多次点击"同步实时情报"，可能触发速率限制。

### 2. 其他常见错误

- **401 Unauthorized**：API Key 无效或已过期
- **403 Forbidden**：API Key 权限不足，未开启 Google Search 工具
- **网络问题**：无法连接到 Gemini API

## 🔍 如何诊断

### 方法 1：查看浏览器控制台

1. 打开浏览器开发者工具（F12）
2. 切换到 "Console" 标签
3. 点击"同步实时情报"
4. 查看错误信息：

```javascript
// 速率限制错误示例
Gemini Error: { status: 429, message: "Rate limit exceeded" }

// API Key 错误示例
Gemini Error: { status: 401, message: "API key not valid" }
```

### 方法 2：检查错误提示

代码已改进，现在会显示更详细的错误信息：
- **速率限制**：会显示 "API 速率限制已触发，请稍后再试"
- **API Key 错误**：会显示具体的错误原因

## ✅ 解决方案

### 方案 1：等待后重试（已自动实现）

代码已添加**自动重试机制**：
- 检测到速率限制（429 错误）时自动重试
- 使用指数退避策略：2秒 → 4秒 → 8秒
- 最多重试 3 次

**操作**：直接点击"重新尝试"按钮，系统会自动处理。

### 方案 2：检查 API Key 配置

1. **确认 API Key 是否正确**
   - 检查 `.env` 文件中的 `API_KEY`
   - 确认没有多余的空格或换行

2. **确认 API Key 权限**
   - 访问 https://aistudio.google.com/app/apikey
   - 确认 API Key 已启用
   - 确认已开启 "Google Search" 功能

3. **检查 API Key 配额**
   - 免费版有使用限制
   - 如果超出限制，需要等待或升级套餐

### 方案 3：减少请求频率

- 避免短时间内多次点击"同步实时情报"
- 建议间隔至少 1-2 分钟

### 方案 4：升级 API 套餐

如果经常遇到速率限制：
1. 访问 https://aistudio.google.com/
2. 升级到付费套餐
3. 获得更高的速率限制

## 🛠️ 代码改进

已添加以下改进：

1. **自动重试机制**
   - 检测速率限制错误
   - 自动等待后重试
   - 指数退避策略

2. **详细错误信息**
   - 区分不同类型的错误
   - 提供针对性的解决建议

3. **错误日志**
   - 在浏览器控制台显示详细错误
   - 方便调试和排查

## 📊 测试步骤

1. **打开浏览器控制台**（F12）
2. **点击"同步实时情报"**
3. **观察控制台输出**：
   - 如果看到 "⚠️ 速率限制，X秒后重试"，说明正在自动处理
   - 如果看到具体错误代码，可以根据错误类型解决

## 💡 提示

- **速率限制是正常的**：这是 API 提供商的保护机制
- **自动重试已启用**：大多数情况下会自动解决
- **查看控制台**：如果问题持续，查看浏览器控制台获取详细信息

## 🔗 相关链接

- [Gemini API 文档](https://ai.google.dev/docs)
- [API 配额和限制](https://ai.google.dev/pricing)
- [获取 API Key](https://aistudio.google.com/app/apikey)
